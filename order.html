<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨ Ù…Ù†ØªØ¬Ø§Øª - ØµÙŠØ¯Ù„ÙŠØ© Ø³Ø§Ø±Ø© Ø§Ù„Ø¹Ø¬Ø±Ù…ÙŠ</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #c7d2fe;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', 'Cairo', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        header { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: var(--gray-900);
            padding: 20px 30px;
            border-radius: 16px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 20px;
            z-index: 100;
        }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo-icon { 
            background: var(--primary); 
            color: white; 
            width: 50px; 
            height: 50px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
        }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .back-btn {
            background: var(--gray-100);
            border: none;
            color: var(--gray-800);
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .back-btn:hover { 
            background: var(--primary-light); 
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }
        .client-badge {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }
        .client-name { font-weight: bold; font-size: 16px; }
        .client-address { font-size: 13px; opacity: 0.9; }
        
        /* Ø²Ø± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù… */
        .cart-fab {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.4);
            transition: all 0.3s;
            border: none;
            font-size: 24px;
        }
        .cart-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(79, 70, 229, 0.6);
        }
        .cart-fab:active {
            transform: scale(0.95);
        }
        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.3);
        }
        
        /* Ø¯Ø±ÙˆØ± Ø§Ù„Ø³Ù„Ø© */
        .cart-drawer {
            position: fixed;
            top: 0;
            left: -450px;
            width: 450px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.15);
            transition: left 0.4s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }
        .cart-drawer.open {
            left: 0;
        }
        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .cart-overlay.show {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .cart-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .cart-header h2 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .close-cart {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }
        .close-cart:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .cart-content {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
        }
        .cart-content::-webkit-scrollbar {
            width: 6px;
        }
        .cart-content::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 10px;
        }
        .cart-content::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 10px;
        }
        
        .cart-items {
            margin-bottom: 20px;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--gray-50);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--gray-200);
            transition: all 0.2s;
        }
        .cart-item:hover {
            border-color: var(--primary-light);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .cart-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            margin-left: 15px;
            flex-shrink: 0;
        }
        .cart-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .cart-item-info {
            flex: 1;
        }
        .cart-item-name { 
            font-weight: 600; 
            color: var(--gray-900);
            margin-bottom: 5px;
            font-size: 16px;
        }
        .cart-item-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-item-price {
            font-weight: 600;
            color: var(--primary);
            font-size: 18px;
        }
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .cart-qty-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: white;
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .cart-qty-btn:hover {
            background: var(--primary-light);
            transform: scale(1.1);
        }
        .cart-qty-input {
            width: 40px;
            text-align: center;
            padding: 5px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            background: white;
        }
        .cart-qty-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .cart-item-remove {
            background: var(--gray-100);
            border: none;
            color: var(--gray-600);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            transition: all 0.2s;
        }
        .cart-item-remove:hover {
            background: var(--danger);
            color: white;
        }
        
        .cart-total {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 25px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-700);
        }
        .total-amount {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
        }
        
        .order-notes {
            margin-bottom: 25px;
        }
        .order-notes label {
            display: block;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 10px;
            font-size: 16px;
        }
        .order-notes textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 15px;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s;
            font-family: inherit;
        }
        .order-notes textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .image-upload {
            margin-bottom: 25px;
        }
        .upload-label {
            display: block;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 10px;
            font-size: 16px;
        }
        .upload-box {
            border: 2px dashed var(--primary-light);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--gray-50);
        }
        .upload-box:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        .upload-icon {
            font-size: 36px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .upload-text { 
            color: var(--gray-700); 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .upload-hint { 
            color: var(--gray-500); 
            font-size: 14px;
        }
        
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--gray-200);
        }
        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .remove-preview {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }
        .remove-preview:hover {
            background: var(--danger);
            transform: scale(1.1);
        }
        
        .checkout-section {
            padding: 0 25px 25px;
        }
        .checkout-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--success) 0%, #34d399 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        .checkout-btn:hover { 
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }
        .checkout-btn:active { transform: translateY(-1px); }
        .checkout-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .products-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 100px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… */
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gray-100);
        }
        .section-title h2 {
            color: var(--gray-900);
            font-size: 28px;
            font-weight: 700;
        }
        .title-icon {
            background: var(--primary);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .product-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            transition: all 0.3s;
            border: 1px solid var(--gray-100);
            position: relative;
            overflow: hidden;
        }
        .product-card:hover { 
            transform: translateY(-8px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.12);
        }
        .product-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 20px;
        }
        .product-image i {
            font-size: 60px;
            color: var(--primary-light);
        }
        
        .product-info { margin-bottom: 20px; }
        .product-name { 
            font-weight: 700; 
            font-size: 20px; 
            color: var(--gray-900);
            margin-bottom: 10px;
        }
        .product-description { 
            color: var(--gray-600); 
            font-size: 15px; 
            line-height: 1.6;
            margin-bottom: 15px;
            height: 48px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .product-price { 
            color: var(--primary); 
            font-weight: 800; 
            font-size: 26px;
            margin-bottom: 20px;
        }
        .product-price:after {
            content: ' Ø¬Ù†ÙŠÙ‡';
            font-size: 18px;
            color: var(--gray-600);
            margin-right: 4px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--gray-50);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .qty-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: white;
            color: var(--primary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
        }
        .qty-btn:hover { 
            background: var(--primary-light); 
            transform: scale(1.1);
        }
        .qty-input {
            flex: 1;
            text-align: center;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            background: white;
        }
        .qty-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .add-to-cart {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
        }
        .add-to-cart:hover { 
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }
        .add-to-cart:active { transform: translateY(0); }
        
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            z-index: 1002;
            animation: slideDown 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 90%;
        }
        @keyframes slideDown {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
        .success { 
            background: var(--success); 
            color: white; 
            border-left: 5px solid #047857;
        }
        .error { 
            background: var(--danger); 
            color: white; 
            border-left: 5px solid #991b1b;
        }
        .info { 
            background: var(--primary); 
            color: white; 
            border-left: 5px solid #3730a3;
        }
        
        .empty-cart {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray-500);
        }
        .empty-cart i { 
            font-size: 60px; 
            color: var(--gray-300); 
            margin-bottom: 20px; 
        }
        .empty-cart h3 { 
            font-size: 20px; 
            margin-bottom: 10px;
            color: var(--gray-700);
        }
        .empty-cart p { 
            font-size: 16px; 
            color: var(--gray-600);
        }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ */
        .tabs-container {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 25px;
            display: flex;
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-600);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tab-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 10px rgba(79, 70, 229, 0.15);
        }
        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
            color: var(--primary);
        }
        
        /* Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ */
        .product-type {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .drug-type {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        .cosmetic-type {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            header { 
                flex-direction: column; 
                gap: 15px; 
                text-align: center; 
                padding: 15px;
            }
            .header-actions { 
                flex-direction: column; 
                width: 100%; 
            }
            .back-btn { 
                width: 100%; 
                justify-content: center; 
            }
            .client-badge { 
                width: 100%; 
                text-align: center; 
            }
            .products-grid { 
                grid-template-columns: 1fr; 
            }
            .cart-drawer {
                width: 100%;
                left: -100%;
            }
            .cart-fab {
                bottom: 20px;
                left: 20px;
                width: 60px;
                height: 60px;
                font-size: 20px;
            }
            .cart-badge {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
            .tabs-container {
                flex-direction: column;
            }
        }

        #uploadProgress {
    margin-top: 15px;
    transition: opacity 0.3s;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--gray-600);
    margin-top: 5px;
}

.preview-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 2px 5px;
    font-size: 11px;
    text-align: center;
}

/* Ø£Ø¶Ù Ù‡Ø°Ø§ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù€ CSS */
.branch-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: fadeIn 0.3s ease;
}

.branch-modal-content {
    background: white;
    border-radius: 20px;
    width: 100%;
    max-width: 500px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.4s ease;
}

@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.branch-modal-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 30px;
    text-align: center;
    position: relative;
}

.branch-modal-icon {
    font-size: 60px;
    margin-bottom: 15px;
    opacity: 0.9;
}

.branch-modal-header h2 {
    font-size: 28px;
    font-weight: 700;
    margin: 0;
}

.branch-modal-body {
    padding: 30px;
}

.branches-list {
    margin: 20px 0;
}

.branch-option {
    display: flex;
    align-items: center;
    padding: 18px;
    background: var(--gray-50);
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.branch-option:hover {
    background: var(--gray-100);
    border-color: var(--primary-light);
}

.branch-option.selected {
    background: linear-gradient(135deg, var(--primary-light) 0%, #e0e7ff 100%);
    border-color: var(--primary);
    box-shadow: 0 5px 20px rgba(79, 70, 229, 0.2);
}

.branch-option input[type="radio"] {
    display: none;
}

.branch-radio-circle {
    width: 24px;
    height: 24px;
    border: 2px solid var(--gray-400);
    border-radius: 50%;
    margin-left: 15px;
    position: relative;
    transition: all 0.3s;
}

.branch-option.selected .branch-radio-circle {
    border-color: var(--primary);
    background: var(--primary);
}

.branch-option.selected .branch-radio-circle::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 12px;
    height: 12px;
    background: white;
    border-radius: 50%;
}

.branch-info {
    flex: 1;
}

.branch-name {
    font-weight: 700;
    color: var(--gray-800);
    font-size: 18px;
    margin-bottom: 5px;
}

.branch-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    padding: 4px 12px;
    border-radius: 20px;
    background: var(--success);
    color: white;
    font-weight: 600;
}

.branch-status.closed {
    background: var(--danger);
}

.branch-selection-info {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bfdbfe;
    border-radius: 10px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--info);
    font-size: 14px;
    margin-top: 20px;
}

.branch-selection-info i {
    font-size: 18px;
    flex-shrink: 0;
}

.branch-modal-footer {
    padding: 20px 30px;
    border-top: 1px solid var(--gray-200);
    text-align: center;
}

.confirm-btn {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    color: white;
    border: none;
    padding: 16px 40px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.3s;
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
    width: 100%;
}

.confirm-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
}

.confirm-btn:disabled {
    background: var(--gray-300);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Ø¹Ø¯Ù„ header Ù„ÙŠÙƒÙˆÙ† Ù‡ÙƒØ°Ø§ -->
<header>
    <div class="logo">
        <div class="logo-icon">
            <i class="fas fa-pills"></i>
        </div>
        <div>
            <h1 style="color: var(--gray-900); font-size: 24px; margin-bottom: 4px;">ØµÙŠØ¯Ù„ÙŠØ© Ø³Ø§Ø±Ø© Ø§Ù„Ø¹Ø¬Ø±Ù…ÙŠ</h1>
            <p style="color: var(--gray-600); font-size: 14px;">Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø¨ØµØ­ØªÙƒ Ù‡ÙŠ Ø£ÙˆÙ„ÙˆÙŠØªÙ†Ø§</p>
        </div>
    </div>
    
    <div class="header-actions">
        <div id="clientInfo"></div>
        
        <!-- Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø¹ -->
        <button class="back-btn" onclick="changeBranch()" id="changeBranchBtn" style="display: none;">
            <i class="fas fa-store"></i>
            <span id="currentBranchText">ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø¹</span>
        </button>
        
        <button class="back-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-home"></i>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </button>
    </div>
</header>
        <!-- Ø£Ø¶Ù Ù‡Ø°Ø§ Ø¨Ø¹Ø¯ header ÙˆÙ‚Ø¨Ù„ products-section -->
<div id="branchSelectionModal" class="branch-modal" style="display: none;">
    <div class="branch-modal-content">
        <div class="branch-modal-header">
            <div class="branch-modal-icon">
                <i class="fas fa-store"></i>
            </div>
            <h2>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹</h2>
        </div>
        
        <div class="branch-modal-body">
            <p id="welcomeMessage" style="color: var(--gray-600); margin-bottom: 20px; line-height: 1.6;">
    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
</p>
            
            <div id="branchesList" class="branches-list">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
            
            <div class="branch-selection-info">
                <i class="fas fa-info-circle"></i>
                <span>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙ‚Ø·</span>
            </div>
        </div>
        
        <div class="branch-modal-footer">
            <button id="confirmBranchBtn" class="confirm-btn">
                <i class="fas fa-check-circle"></i>
                ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            </button>
        </div>
    </div>
</div>
        <!-- Ø¯Ø±ÙˆØ± Ø§Ù„Ø³Ù„Ø© (Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
        <div class="cart-overlay" id="cartOverlay"></div>
        <div class="cart-drawer" id="cartDrawer">
            <div class="cart-header">
                <h2>
                    <i class="fas fa-shopping-cart"></i>
                    Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                </h2>
                <button class="close-cart" onclick="closeCart()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="cart-content" id="cartContent">
                <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ù„Ø© Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
            
            <div class="checkout-section">
                <button id="checkoutBtn" class="checkout-btn" onclick="placeOrder()" disabled>
                    <i class="fas fa-check-circle"></i>
                    <span id="checkoutText">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</span>
                    <span id="checkoutLoading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                </button>
            </div>
        </div>
        
        <!-- Ø²Ø± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù… -->
        <button class="cart-fab" onclick="toggleCart()">
            <i class="fas fa-shopping-cart"></i>
            <div class="cart-badge" id="cartBadge">0</div>
        </button>
        
        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <section class="products-section">
            <div class="section-title">
                <div class="title-icon">
                    <i class="fas fa-pills"></i>
                </div>
                <h2>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
            </div>
            
            <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙˆØ§Ù„Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª -->
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('drugs')" id="drugsTab">
                    <i class="fas fa-capsules"></i>
                    Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
                </button>
                <button class="tab-btn" onclick="switchTab('cosmetics')" id="cosmeticsTab">
                    <i class="fas fa-spray-can-sparkles"></i>
                    Ø§Ù„Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª
                </button>
                <button class="tab-btn" onclick="switchTab('all')" id="allTab">
                    <i class="fas fa-list"></i>
                    Ø§Ù„ÙƒÙ„
                </button>
            </div>
            
            <div id="productsContainer" class="products-grid">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
            </div>
            
            <div id="loadingIndicator" style="text-align: center; padding: 40px; color: var(--gray-600);">
                <i class="fas fa-spinner fa-spin" style="font-size: 40px; margin-bottom: 20px;"></i>
                <p style="font-size: 18px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
            </div>
        </section>
    </div>

    <div id="message" class="message"></div>

    <script>
    const API_BASE = 'https://elagramy-phamacy-production.up.railway.app/api';
    let drugs = [];
    let cosmetics = [];
    let allProducts = [];
    let cart = [];
    let clientId = null;
    let clientData = null;
    let prescriptionImages = [];
    let currentTab = 'drugs';
    let selectedBranchId = null;
    let availableBranches = [];
    // Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ø¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    let userBranches = []; // Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠÙ‡Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„
    let selectedBranchForShopping = null;
    
        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹
async function showBranchSelection() {
    try {
        console.log('ğŸª Ø¬Ù„Ø¨ ÙØ±ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±...');
        
        // Ø¬Ù„Ø¨ ÙØ±ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠÙ‡Ø§
        const response = await fetch(`${API_BASE}/clients/${clientId}/branches`);
        const data = await response.json();
        
        if (data.success && data.data && data.data.length > 0) {
            userBranches = data.data;
            
            // ğŸ”¥ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ - Ø¯Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ®ØªØ§Ø± Ø¨Ù†ÙØ³Ù‡
            /*
            // Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯:
            if (userBranches.length === 1) {
                selectedBranchForShopping = userBranches[0].branch_id || userBranches[0].branches?.id;
                selectedBranchId = selectedBranchForShopping;
                console.log(`âœ… ÙØ±Ø¹ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·ØŒ ØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ${selectedBranchForShopping}`);
                hideBranchModal();
                loadProducts();
                return;
            }
            */
            
            // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
            displayBranchSelection(userBranches);
            
        } else {
            console.warn('âš ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø£ÙŠ ÙØ±Ø¹');
            showMessage('Ø£Ù†Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø£ÙŠ ÙØ±Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ ÙØ±Ø¹ Ø£ÙˆÙ„Ø§Ù‹.', 'error');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 3000);
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ÙØ±ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„:', error);
        showMessage('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹', 'error');
    }
}
// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹
function displayBranchSelection(branches) {
    const modal = document.getElementById('branchSelectionModal');
    const branchesList = document.getElementById('branchesList');
    
    // ğŸ”¥ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    selectedBranchForShopping = null;
    selectedBranchId = null;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹
    let branchesHtml = '';
    
    branches.forEach((branch, index) => {
        const branchId = branch.branch_id || branch.branches?.id;
        const branchName = branch.branches?.name || 'ÙØ±Ø¹';
        const isActive = branch.branches?.is_active !== false;
        
        // ğŸ”¥ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        // Ù„Ø§ ØªÙØ¹Ù„: if (index === 0 && isActive) { selectedBranchForShopping = branchId; }
        
        branchesHtml += `
            <div class="branch-option ${!isActive ? 'disabled' : ''}" 
                 onclick="${isActive ? `selectBranch(${branchId}, this)` : ''}">
                <input type="radio" 
                       name="branch" 
                       id="branch_${branchId}" 
                       value="${branchId}"
                       ${!isActive ? 'disabled' : ''}>
                
                <div class="branch-radio-circle"></div>
                
                <div class="branch-info">
                    <div class="branch-name">
                        ${branchName}
                        ${branch.branches?.address ? `
                            <div style="font-size: 14px; color: var(--gray-600); margin-top: 4px;">
                                <i class="fas fa-map-marker-alt"></i>
                                ${branch.branches.address}
                            </div>
                        ` : ''}
                    </div>
                    <div class="branch-status ${isActive ? '' : 'closed'}">
                        <i class="fas fa-${isActive ? 'check-circle' : 'times-circle'}"></i>
                        ${isActive ? 'Ù†Ø´Ø·' : 'Ù…ØºÙ„Ù‚ Ù…Ø¤Ù‚ØªØ§Ù‹'}
                    </div>
                </div>
            </div>
        `;
    });
    
    branchesList.innerHTML = branchesHtml;
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    modal.style.display = 'flex';
    
    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
    const confirmBtn = document.getElementById('confirmBranchBtn');
    confirmBtn.disabled = true; // ğŸ”¥ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹
    confirmBtn.innerHTML = `
        <i class="fas fa-hand-point-up"></i>
        Ø§Ø®ØªØ± ÙØ±Ø¹Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
    `;
}

// Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹
function selectBranch(branchId, element) {
    console.log(`ğŸ¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹: ${branchId}`);
    
    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ù‚Ù…
    selectedBranchForShopping = parseInt(branchId);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    document.querySelectorAll('.branch-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø±
    if (element) {
        element.classList.add('selected');
    }
    
    // ğŸ”¥ ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
    const confirmBtn = document.getElementById('confirmBranchBtn');
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = `
        <i class="fas fa-check-circle"></i>
        ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    `;
    
    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ±Ø¹ ${branchId} Ù…Ø¤Ù‚ØªØ§Ù‹`);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
function hideBranchModal() {
    const modal = document.getElementById('branchSelectionModal');
    modal.style.display = 'none';
}

// Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµÙØ­
function changeBranch() {
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹
    if (userBranches.length > 1) {
        showBranchSelection();
    } else {
        showMessage('Ø£Ù†Øª Ù…Ø³Ø¬Ù„ ÙÙŠ ÙØ±Ø¹ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·', 'info');
    }
}

    function showMessage(text, type = 'info', duration = 5000) {
        const msgDiv = document.getElementById('message');
        msgDiv.innerHTML = `<div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${text}</span>
        </div>`;
        msgDiv.className = `message ${type}`;
        msgDiv.style.display = 'block';
        
        setTimeout(() => {
            msgDiv.style.display = 'none';
        }, duration);
    }
    
    function switchTab(tab) {
        currentTab = tab;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        document.getElementById('drugsTab').classList.remove('active');
        document.getElementById('cosmeticsTab').classList.remove('active');
        document.getElementById('allTab').classList.remove('active');
        
        if (tab === 'drugs') {
            document.getElementById('drugsTab').classList.add('active');
            displayProducts(drugs, 'Ø¯ÙˆØ§Ø¡');
        } else if (tab === 'cosmetics') {
            document.getElementById('cosmeticsTab').classList.add('active');
            displayProducts(cosmetics, 'Ù…Ø³ØªØ­Ø¶Ø±');
        } else {
            document.getElementById('allTab').classList.add('active');
            displayProducts(allProducts, 'Ù…Ù†ØªØ¬');
        }
    }
    
    async function loadBranches() {
        try {
            console.log('ğŸª Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙˆØ¹...');
            const response = await fetch(`${API_BASE}/branches`);
            const data = await response.json();
            
            if (data.success && data.data && data.data.length > 0) {
                availableBranches = data.data;
                selectedBranchId = data.data[0].id;
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.data.length} ÙØ±Ø¹`);
                console.log('ğŸ“‹ Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©:', data.data);
                return true;
            } else {
                console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ Ù…ØªØ§Ø­Ø©');
                return false;
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙˆØ¹:', error);
            return false;
        }
    }
    
    async function loadDrugs() {
    try {
        console.log('ğŸ’Š Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©...');
        const response = await fetch(`${API_BASE}/products/drugs`);
        const data = await response.json();
        
        console.log('ğŸ“Š Ø§Ø³ØªØ¬Ø§Ø¨Ø© API Ù„Ù„Ø£Ø¯ÙˆÙŠØ©:', data); // ğŸ‘ˆ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
        console.log('ğŸ” Ø£ÙˆÙ„ Ø¯ÙˆØ§Ø¡ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:', data.data ? data.data[0] : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); // ğŸ‘ˆ ÙˆÙ‡Ø°Ø§ Ø£ÙŠØ¶Ø§Ù‹
        
        if (data.success) {
            drugs = data.data || [];
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${drugs.length} Ø¯ÙˆØ§Ø¡`);
            
            // ØªØµØ­ÙŠØ­: ØªØ·Ø¨ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
            drugs = drugs.map(drug => {
                console.log(`ğŸ”¬ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ø¡ ${drug.id}:`, drug); // ğŸ‘ˆ ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ Ø¯ÙˆØ§Ø¡
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                let price = 0;
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ø£Ù…Ø§ÙƒÙ† Ù…Ø®ØªÙ„ÙØ©
                if (drug.price !== undefined && drug.price !== null) {
                    price = drug.price;
                    console.log(`ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ù…Ù† drug.price: ${price}`);
                } else if (drug.sale_price !== undefined && drug.sale_price !== null) {
                    price = drug.sale_price;
                    console.log(`ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ù…Ù† drug.sale_price: ${price}`);
                } else if (drug.unit_price !== undefined && drug.unit_price !== null) {
                    price = drug.unit_price;
                    console.log(`ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ù…Ù† drug.unit_price: ${price}`);
                } else if (drug.retail_price !== undefined && drug.retail_price !== null) {
                    price = drug.retail_price;
                    console.log(`ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ù…Ù† drug.retail_price: ${price}`);
                } else {
                    console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ù„Ù„Ø¯ÙˆØ§Ø¡ ${drug.id}: ${drug.name}`);
                    price = 0;
                }
                
                return {
                    ...drug,
                    type: 'drug',
                    display_price: price,
                    display_name: drug.name || drug.product_name || 'Ø¯ÙˆØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                    display_description: drug.description || drug.active_ingredient || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­'
                };
            });
            
            return true;
        } else {
            console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:', data.message);
            return false;
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:', error);
        return false;
    }
}


    async function loadCosmetics() {
        try {
            console.log('ğŸ’„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª...');
            const response = await fetch(`${API_BASE}/products/cosmetics`);
            const data = await response.json();
            
            if (data.success) {
                cosmetics = data.data || [];
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${cosmetics.length} Ù…Ø³ØªØ­Ø¶Ø±`);
                
                // ØªØµØ­ÙŠØ­: ØªØ·Ø¨ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª
                cosmetics = cosmetics.map(cosmetic => ({
                    ...cosmetic,
                    type: 'cosmetic',
                    display_price: cosmetic.price || cosmetic.sale_price || cosmetic.unit_price || 0,
                    display_name: cosmetic.name || cosmetic.product_name || 'Ù…Ø³ØªØ­Ø¶Ø± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                    display_description: cosmetic.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­'
                }));
                
                return true;
            } else {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª:', data.message);
                return false;
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª:', error);
            return false;
        }
    }
    
    async function loadProducts() {
  console.log('ğŸ”„ loadProducts - Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
    console.log('- selectedBranchId Ù‚Ø¨Ù„:', selectedBranchId);
    
    // ğŸ”¥ ØªÙˆÙ‚Ù Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹ Ø¨Ø¹Ø¯
    if (!selectedBranchId) {
        console.log('â¸ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹ Ø¨Ø¹Ø¯ØŒ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <i class="fas fa-store" style="font-size: 40px; color: var(--gray-400); margin-bottom: 20px;"></i>
                <h3 style="color: var(--gray-700); margin-bottom: 10px;">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹</h3>
                <p style="color: var(--gray-600); margin-bottom: 20px;">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
                <button onclick="showBranchSelection()" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-store"></i> Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹
                </button>
            </div>
        `;
        
        // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        document.getElementById('productsContainer').innerHTML = '';
        return;
    }
    
    console.log(`âœ… Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙØ±Ø¹: ${selectedBranchId}`);
    
    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
    updateCurrentBranchButton();

    try {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.display = 'block';
        loadingIndicator.innerHTML = `
            <i class="fas fa-spinner fa-spin" style="font-size: 40px; margin-bottom: 20px;"></i>
            <p style="font-size: 18px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙØ±Ø¹...</p>
        `;
        
        // ğŸ”¥ Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ - Ù„Ø§ ØªØ®ØªØ§Ø± ÙØ±Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        // Ù„Ø§ ØªÙØ¹Ù„ Ù‡Ø°Ø§: selectedBranchId = branchesData.data[0].id;
        
        // ÙÙ‚Ø· Ø¬Ù„Ø¨ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
        console.log(`ğŸ“¦ Ø¬Ù„Ø¨ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙØ±Ø¹ ${selectedBranchId}...`);
        const productsResponse = await fetch(`${API_BASE}/branches/${selectedBranchId}/products`);
        const productsData = await productsResponse.json();
        
        console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', productsData);
        
        if (productsData.success && productsData.data) {
            // ØªÙØ±ÙŠØº Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            drugs = [];
            cosmetics = [];
            
            // ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            productsData.data.forEach(product => {
                const itemData = {
                    id: product.id,
                    type: product.type, // 'drug' Ø£Ùˆ 'cosmetic'
                    branch_id: product.branch_id,
                    price: product.price, // âœ… Ù‡Ù†Ø§ Ø§Ù„Ø³Ø¹Ø±!
                    quantity: product.quantity,
                    is_available: product.is_available,
                    branch_product_id: product.id
                };
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                if (product.type === 'drug' && product.drugs) {
                    const drugInfo = {
                        ...itemData,
                        product_id: product.drug_id,
                        name: product.drugs.name,
                        image_url: product.drugs.image_url,
                        description: product.drugs.medical_notes || product.drugs.active_ingredient || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ',
                        active_ingredient: product.drugs.active_ingredient,
                        concentration: product.drugs.concentration,
                        category_id: product.drugs.category_id,
                        provider_id: product.drugs.provider_id
                    };
                    
                    drugs.push(drugInfo);
                    
                } else if (product.type === 'cosmetic' && product.cosmetics) {
                    const cosmeticInfo = {
                        ...itemData,
                        product_id: product.cosmetic_id,
                        name: product.cosmetics.name,
                        image_url: product.cosmetics.image_url,
                        description: product.cosmetics.description || product.cosmetics.additional_notes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ',
                        package_size: product.cosmetics.package_size,
                        category_id: product.cosmetics.category_id,
                        provider_id: product.cosmetics.provider_id
                    };
                    
                    cosmetics.push(cosmeticInfo);
                }
            });
            
            // Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ÙƒÙ„"
            allProducts = [...drugs, ...cosmetics];
            
            console.log('ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:');
            console.log(`- Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©: ${drugs.length}`);
            console.log(`- Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª: ${cosmetics.length}`);
            console.log(`- Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${allProducts.length}`);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
            switchTab(currentTab);
            
            // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            loadingIndicator.style.display = 'none';
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            if (allProducts.length > 0) {
                const branchName = productsData.branch?.name || 'Ø§Ù„ÙØ±Ø¹';
                showMessage(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allProducts.length} Ù…Ù†ØªØ¬ Ù…Ù† ${branchName}`, 'success', 3000);
            } else {
                showMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹', 'info');
            }
            
        } else {
            throw new Error(productsData.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', error);
        showMessage('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', 'error');
        
        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById('loadingIndicator').style.display = 'none';
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        loadSampleData();
    }
}

    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
    function loadSampleData() {
        console.log('ğŸ“‹ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        
        drugs = [
            {
                id: 1,
                type: 'drug',
                name: 'Ø¨Ø§Ù†Ø§Ø¯ÙˆÙ„ Ø¥ÙƒØ³ØªØ±Ø§',
                display_name: 'Ø¨Ø§Ù†Ø§Ø¯ÙˆÙ„ Ø¥ÙƒØ³ØªØ±Ø§',
                display_price: 15.5,
                display_description: 'Ù…Ø³ÙƒÙ† Ù„Ù„Ø£Ù„Ù… ÙˆØ®Ø§ÙØ¶ Ù„Ù„Ø­Ø±Ø§Ø±Ø©',
                active_ingredient: 'Ø¨Ø§Ø±Ø§Ø³ÙŠØªØ§Ù…ÙˆÙ„ØŒ ÙƒØ§ÙÙŠÙŠÙ†'
            },
            {
                id: 2,
                type: 'drug',
                name: 'Ø£Ù…ÙˆÙƒØ³ÙŠØ³ÙŠÙ„ÙŠÙ† 500 Ù…Ø¬Ù…',
                display_name: 'Ø£Ù…ÙˆÙƒØ³ÙŠØ³ÙŠÙ„ÙŠÙ† 500 Ù…Ø¬Ù…',
                display_price: 25,
                display_description: 'Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø§Ù„ØªÙ‡Ø§Ø¨Ø§Øª Ø§Ù„Ø¨ÙƒØªÙŠØ±ÙŠØ©',
                active_ingredient: 'Ø£Ù…ÙˆÙƒØ³ÙŠØ³ÙŠÙ„ÙŠÙ†'
            },
            {
                id: 3,
                type: 'drug',
                name: 'ÙÙŠØªØ§Ù…ÙŠÙ† Ø³ÙŠ 1000 Ù…Ø¬Ù…',
                display_name: 'ÙÙŠØªØ§Ù…ÙŠÙ† Ø³ÙŠ 1000 Ù…Ø¬Ù…',
                display_price: 30,
                display_description: 'Ù…Ù‚ÙˆÙŠ Ù„Ù„Ù…Ù†Ø§Ø¹Ø© ÙˆÙ…Ø¶Ø§Ø¯ Ù„Ù„Ø£ÙƒØ³Ø¯Ø©',
                active_ingredient: 'ÙÙŠØªØ§Ù…ÙŠÙ† Ø³ÙŠ'
            }
        ];
        
        cosmetics = [
            {
                id: 4,
                type: 'cosmetic',
                name: 'ÙƒØ±ÙŠÙ… Ù…Ø±Ø·Ø¨ Ù„Ù„ÙˆØ¬Ù‡',
                display_name: 'ÙƒØ±ÙŠÙ… Ù…Ø±Ø·Ø¨ Ù„Ù„ÙˆØ¬Ù‡',
                display_price: 45,
                display_description: 'ÙƒØ±ÙŠÙ… Ù…Ø±Ø·Ø¨ Ø¹Ù…ÙŠÙ‚ Ù„Ù„Ø¨Ø´Ø±Ø© Ø§Ù„Ø¬Ø§ÙØ©'
            },
            {
                id: 5,
                type: 'cosmetic',
                name: 'Ø´Ø§Ù…Ø¨Ùˆ Ø¹Ù„Ø§Ø¬ÙŠ Ù„Ù„Ù‚Ø´Ø±Ø©',
                display_name: 'Ø´Ø§Ù…Ø¨Ùˆ Ø¹Ù„Ø§Ø¬ÙŠ Ù„Ù„Ù‚Ø´Ø±Ø©',
                display_price: 35,
                display_description: 'Ø´Ø§Ù…Ø¨Ùˆ Ø·Ø¨ÙŠ Ù„Ø¹Ù„Ø§Ø¬ Ù‚Ø´Ø±Ø© Ø§Ù„Ø±Ø£Ø³'
            }
        ];
        
        allProducts = [...drugs, ...cosmetics];
        
        showMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'info');
        switchTab(currentTab);
    }
    
    function displayProducts(products, productType) {
    const container = document.getElementById('productsContainer');
    
    if (!products || products.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--gray-500);">
                <i class="fas fa-box-open" style="font-size: 60px; margin-bottom: 20px;"></i>
                <h3 style="font-size: 22px; margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ${productType}Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
                <p style="font-size: 16px; color: var(--gray-600);">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ${productType}Ø§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        
        // Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬
        const typeBadge = product.type === 'drug' ? 
            '<span class="product-type drug-type">Ø¯ÙˆØ§Ø¡</span>' : 
            '<span class="product-type cosmetic-type">Ù…Ø³ØªØ­Ø¶Ø±</span>';
        
        // ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬
        const imageUrl = product.image_url || '';
        
        // âœ… Ø§Ù„Ø¢Ù† Ø§Ù„Ø³Ø¹Ø± Ù…ÙˆØ¬ÙˆØ¯!
        const price = product.price || 0;
        const formattedPrice = typeof price === 'number' ? price.toFixed(2) : '0.00';
        
        // Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙˆØµÙ
        const name = product.name || 'Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
        const description = product.description || 
                          (product.type === 'drug' ? product.active_ingredient : '') || 
                          'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­';
        
        productCard.innerHTML = `
            ${typeBadge}
            <div class="product-image">
                ${imageUrl ? 
                    `<img src="${imageUrl}" alt="${name}" loading="lazy" style="padding: 20px;">` : 
                    `<i class="fas ${product.type === 'drug' ? 'fa-capsules' : 'fa-spray-can-sparkles'}"></i>`
                }
            </div>
            <div class="product-info">
                <div class="product-name">${name}</div>
                <div class="product-description">
                    ${description}
                    ${product.type === 'drug' && product.concentration ? 
                        `<br><small style="color: var(--gray-500);">ØªØ±ÙƒÙŠØ²: ${product.concentration}</small>` : 
                        ''}
                    ${product.type === 'cosmetic' && product.package_size ? 
                        `<br><small style="color: var(--gray-500);">Ø§Ù„Ø­Ø¬Ù…: ${product.package_size}</small>` : 
                        ''}
                </div>
                <div class="product-price">${formattedPrice}</div>
            </div>
            <div class="quantity-controls">
                <button class="qty-btn" onclick="updateQuantity(${product.id}, '${product.type}', -1)">
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" 
                       id="qty-${product.type}-${product.id}" 
                       class="qty-input" 
                       value="0" 
                       min="0" 
                       max="${product.quantity || 99}" 
                       readonly
                       onchange="updateCartFromInput(${product.id}, '${product.type}', this.value)">
                <button class="qty-btn" onclick="updateQuantity(${product.id}, '${product.type}', 1)">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <button class="add-to-cart" onclick="addToCart(${product.id}, '${product.type}')" 
                    ${(!product.is_available || product.quantity <= 0) ? 'disabled style="opacity: 0.5;"' : ''}>
                <i class="fas fa-cart-plus"></i>
                ${(!product.is_available || product.quantity <= 0) ? 'ØºÙŠØ± Ù…ØªÙˆÙØ±' : 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©'}
            </button>
        `;
        
        container.appendChild(productCard);
    });
}


    function updateQuantity(productId, productType, change) {
        const input = document.getElementById(`qty-${productType}-${productId}`);
        if (!input) return;
        
        let newValue = parseInt(input.value) + change;
        
        if (newValue < 0) newValue = 0;
        if (newValue > 99) newValue = 99;
        
        input.value = newValue;
        updateCartFromQuantity(productId, productType, newValue);
    }
    
    function updateCartFromInput(productId, productType, value) {
        const quantity = parseInt(value) || 0;
        updateCartFromQuantity(productId, productType, quantity);
    }
    
    function addToCart(productId, productType) {
        const input = document.getElementById(`qty-${productType}-${productId}`);
        if (!input) return;
        
        const quantity = parseInt(input.value);
        
        if (quantity <= 0) {
            showMessage('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ…ÙŠØ©', 'error');
            return;
        }
        
        updateCartFromQuantity(productId, productType, quantity);
        input.value = 0;
        showMessage('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© âœ“', 'success');
    }
    
    function getProductById(productId, productType) {
    console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬: ${productType}-${productId}`);
    
    if (productType === 'drug') {
        const found = drugs.find(p => p.id === productId || p.product_id === productId);
        console.log(`ğŸ” Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:`, found);
        return found;
    } else if (productType === 'cosmetic') {
        const found = cosmetics.find(p => p.id === productId || p.product_id === productId);
        console.log(`ğŸ” Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª:`, found);
        return found;
    }
    
    console.warn(`âŒ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ${productType}`);
    return null;
}


    function updateCartFromQuantity(productId, productType, quantity) {
    const product = getProductById(productId, productType);
    if (!product) return;
    
    // ğŸ”¥ Ø§Ø³ØªØ®Ø¯Ù… branch_product_id Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† product_id
    const branchProductId = product.branch_product_id || product.id;
    
    const existingIndex = cart.findIndex(item => 
        item.branch_product_id === branchProductId && item.product_type === productType
    );
    
    if (quantity === 0) {
        if (existingIndex !== -1) {
            cart.splice(existingIndex, 1);
        }
    } else {
        const price = product.price || product.display_price || 0;
        
        if (existingIndex !== -1) {
            cart[existingIndex].quantity = quantity;
        } else {
            cart.push({
                product_type: productType,
                branch_product_id: branchProductId, // ğŸ”¥ ØªØ®Ø²ÙŠÙ† branch_product_id
                product_id: product.product_id || product.id, // ğŸ”¥ ØªØ®Ø²ÙŠÙ† Ø£ÙŠØ¶Ø§Ù‹ Ù„Ù„Ø±Ø¬ÙˆØ¹
                quantity: quantity,
                name: product.name || product.display_name,
                price: price,
                type: product.type
            });
        }
    }
    
    updateCartBadge();
    updateCartDisplay();
}

    function updateCartBadge() {
        const cartBadge = document.getElementById('cartBadge');
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartBadge.textContent = totalItems;
        cartBadge.style.display = totalItems > 0 ? 'flex' : 'none';
        
        // Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø© ÙÙŠ localStorage
        localStorage.setItem('saved_cart', JSON.stringify(cart));
    }
    
    function updateCartDisplay() {
        const cartContent = document.getElementById('cartContent');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const checkoutText = document.getElementById('checkoutText');
        const checkoutLoading = document.getElementById('checkoutLoading');
        
        if (cart.length === 0) {
            cartContent.innerHTML = `
                <div class="empty-cart">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙØ§Ø±ØºØ©</h3>
                    <p>Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø·Ù„Ø¨</p>
                </div>
                <div class="cart-total">
                    <span class="total-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
                    <span class="total-amount">0 Ø¬Ù†ÙŠÙ‡</span>
                </div>
            `;
            checkoutBtn.disabled = true;
            checkoutText.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
            checkoutLoading.style.display = 'none';
            return;
        }
        
        let total = 0;
        let itemsHtml = '';
        
        cart.forEach(item => {
            const itemTotal = (item.price || 0) * item.quantity;
            total += itemTotal;
            
            const typeIcon = item.product_type === 'drug' ? 'fa-capsules' : 'fa-spray-can-sparkles';
            const typeColor = item.product_type === 'drug' ? 'var(--success)' : '#3b82f6';
            
            itemsHtml += `
                <div class="cart-item">
                    <div class="cart-item-image" style="background: ${typeColor}20;">
                        <i class="fas ${typeIcon}" style="color: ${typeColor}; font-size: 28px; display: flex; align-items: center; justify-content: center; height: 100%;"></i>
                    </div>
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-details">
                            <div class="cart-item-price">${itemTotal.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                            <div class="cart-item-quantity">
                                <button class="cart-qty-btn" onclick="updateCartItemQuantity('${item.product_type}', ${item.product_id}, -1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="text" 
                                       value="${item.quantity}" 
                                       class="cart-qty-input" 
                                       readonly>
                                <button class="cart-qty-btn" onclick="updateCartItemQuantity('${item.product_type}', ${item.product_id}, 1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button class="cart-item-remove" onclick="removeFromCart('${item.product_type}', ${item.product_id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        });
        
        // Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„ØµÙˆØ±
        const formSection = `
            <div class="order-notes">
                <label for="prescription">
                    <i class="fas fa-notes-medical"></i>
                    Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                </label>
                <textarea id="prescription" 
                          placeholder="ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±ÙØ§Ù‚ Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ© Ø£Ùˆ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø®Ø§ØµØ©...
Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯Ù‡Ø§ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©..."></textarea>
            </div>
            
            <div class="image-upload">
    <label class="upload-label">
        <i class="fas fa-camera"></i>
        Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        <span style="font-size: 12px; color: var(--gray-500); font-weight: normal; margin-right: 5px;">
            - ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø­ØªÙ‰ 5 ØµÙˆØ±
        </span>
    </label>
    
    <div class="upload-box" onclick="document.getElementById('imageUpload').click()">
        <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <div class="upload-text">Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±</div>
        <div class="upload-hint">
            <i class="fas fa-info-circle"></i>
            JPG, PNG, WEBP - Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… 5MB Ù„Ù„ØµÙˆØ±Ø©
        </div>
        <div id="uploadProgress" style="display: none; margin-top: 10px;">
            <div style="width: 100%; background: var(--gray-200); height: 4px; border-radius: 2px;">
                <div id="progressBar" style="width: 0%; height: 100%; background: var(--primary); border-radius: 2px;"></div>
            </div>
            <div id="progressText" style="font-size: 12px; color: var(--gray-600); margin-top: 5px;"></div>
        </div>
    </div>
    
    <input type="file" 
           id="imageUpload" 
           multiple 
           accept="image/*" 
           style="display: none"
           onchange="handleImageUpload(event)">
    
    <div id="imagePreview" class="image-preview"></div>
    
    <!-- Ù…Ù„Ø§Ø­Ø¸Ø© Ø­ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± -->
    <div style="margin-top: 10px; padding: 10px; background: var(--gray-50); border-radius: 8px; border-right: 3px solid var(--primary-light);">
        <div style="display: flex; align-items: center; gap: 8px; color: var(--gray-600); font-size: 13px;">
            <i class="fas fa-lightbulb" style="color: var(--warning);"></i>
            <span>
                <strong>Ù†ØµÙŠØ­Ø©:</strong> ÙŠÙ…ÙƒÙ†Ùƒ ØªØµÙˆÙŠØ± Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ© ÙˆØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù„ÙŠØªÙ… ØµØ±Ù Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø¨Ø¯Ù‚Ø©
            </span>
        </div>
    </div>
</div>
        `;
        
        cartContent.innerHTML = `
            <div class="cart-items">
                ${itemsHtml}
            </div>
            <div class="cart-total">
                <span class="total-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
                <span class="total-amount">${total.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span>
            </div>
            ${formSection}
        `;
        
        checkoutBtn.disabled = false;
    }
    
    function updateCartItemQuantity(productType, productId, change) {
        const item = cart.find(item => 
            item.product_type === productType && item.product_id === productId
        );
        if (!item) return;
        
        const newQuantity = item.quantity + change;
        if (newQuantity < 1) {
            removeFromCart(productType, productId);
            return;
        }
        
        updateCartFromQuantity(productId, productType, newQuantity);
    }
    
    function removeFromCart(productType, productId) {
        const originalLength = cart.length;
        cart = cart.filter(item => 
            !(item.product_type === productType && item.product_id === productId)
        );
        
        if (cart.length < originalLength) {
            const input = document.getElementById(`qty-${productType}-${productId}`);
            if (input) input.value = 0;
            
            updateCartBadge();
            updateCartDisplay();
            showMessage('ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø©', 'success');
        }
    }
    
    // ÙˆØ¸Ø§Ø¦Ù ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ù„Ø©
    function toggleCart() {
        const drawer = document.getElementById('cartDrawer');
        const overlay = document.getElementById('cartOverlay');
        
        drawer.classList.toggle('open');
        overlay.classList.toggle('show');
        
        // Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø³Ù„Ø©ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        if (drawer.classList.contains('open')) {
            updateCartDisplay();
        }
        
        // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø³Ù„Ø©
        document.body.style.overflow = drawer.classList.contains('open') ? 'hidden' : '';
    }
    
    function closeCart() {
        const drawer = document.getElementById('cartDrawer');
        const overlay = document.getElementById('cartOverlay');
        
        drawer.classList.remove('open');
        overlay.classList.remove('show');
        document.body.style.overflow = '';
    }
    
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± - Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø©
async function handleImageUpload(event) {
    const files = Array.from(event.target.files);
    const previewContainer = document.getElementById('imagePreview');
    
    const maxImages = 5;
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    const maxSize = 5 * 1024 * 1024; // 5MB
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
    if (prescriptionImages.length + files.length > maxImages) {
        showMessage(`ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ${maxImages} ØµÙˆØ± ÙÙ‚Ø·`, 'error');
        event.target.value = '';
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§ÙˆÙŠØ© Ù…Ø¤Ù‚ØªØ© Ù„Ù„ØªØ­Ù…ÙŠÙ„
    const loadingContainer = document.createElement('div');
    loadingContainer.innerHTML = `
        <div style="text-align: center; padding: 10px; color: var(--gray-600);">
            <i class="fas fa-spinner fa-spin"></i>
            Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±...
        </div>
    `;
    previewContainer.appendChild(loadingContainer);
    
    let validFiles = 0;
    
    try {
        for (const file of files) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
            if (!allowedTypes.includes(file.type)) {
                showMessage(`ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù "${file.name}" ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©`, 'error');
                continue;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
            if (file.size > maxSize) {
                showMessage(`Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù "${file.name}" ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB)`, 'error');
                continue;
            }
            
            try {
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ base64
                const base64Image = await fileToBase64(file);
                
                // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                const optimizedImage = await optimizeImage(base64Image);
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ©
                prescriptionImages.push({
                    base64: optimizedImage,
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
                
                validFiles++;
                
                // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØºØ±Ø©
                displayImagePreview(optimizedImage, prescriptionImages.length - 1);
                
            } catch (processingError) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©:', processingError);
                showMessage(`Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù "${file.name}"`, 'error');
            }
        }
        
    } finally {
        // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingContainer.remove();
    }
    
    if (validFiles > 0) {
        showMessage(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${validFiles} ØµÙˆØ±Ø© Ù„Ù„Ø±ÙˆØ´ØªØ©`, 'success');
    }
    
    event.target.value = '';
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¶ØºØ· Ø§Ù„ØµÙˆØ±
function optimizeImage(base64Image) {
    return new Promise((resolve) => {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© Ø£Ù‚Ù„ Ù…Ù† 1MBØŒ Ù„Ø§ Ù†Ø¶ØºØ·Ù‡Ø§
        if (base64Image.length < 1_000_000) {
            resolve(base64Image);
            return;
        }
        
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 1200px)
            const maxWidth = 1200;
            const maxHeight = 1200;
            
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
                height = (maxWidth / width) * height;
                width = maxWidth;
            }
            
            if (height > maxHeight) {
                width = (maxHeight / height) * width;
                height = maxHeight;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            ctx.drawImage(img, 0, 0, width, height);
            
            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ base64 Ø¨Ø¬ÙˆØ¯Ø© 80%
            const optimizedBase64 = canvas.toDataURL('image/jpeg', 0.8);
            resolve(optimizedBase64);
        };
        
        img.src = base64Image;
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØµØºØ±Ø©
function displayImagePreview(base64Image, index) {
    const previewContainer = document.getElementById('imagePreview');
    
    const previewItem = document.createElement('div');
    previewItem.className = 'preview-item';
    previewItem.innerHTML = `
        <img src="${base64Image}" class="preview-image" alt="ØµÙˆØ±Ø© ${index + 1}">
        <button class="remove-preview" onclick="removeImage(${index})" title="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©">
            <i class="fas fa-times"></i>
        </button>
        <div class="preview-info" style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; padding: 2px 5px; font-size: 11px; text-align: center;">
            ${index + 1}
        </div>
    `;
    
    previewContainer.appendChild(previewItem);
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}


    function removeImage(index) {
    if (index >= 0 && index < prescriptionImages.length) {
        prescriptionImages.splice(index, 1);
        updateImagePreview();
    }
}

function updateImagePreview() {
    const previewContainer = document.getElementById('imagePreview');
    previewContainer.innerHTML = '';
    
    prescriptionImages.forEach((image, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        previewItem.innerHTML = `
            <img src="${image.base64}" class="preview-image" alt="ØµÙˆØ±Ø© ${index + 1}">
            <button class="remove-preview" onclick="removeImage(${index})" title="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©">
                <i class="fas fa-times"></i>
            </button>
            <div class="preview-info" style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; padding: 2px 5px; font-size: 11px; text-align: center;">
                ${index + 1}
            </div>
        `;
        previewContainer.appendChild(previewItem);
    });
}


    async function placeOrder() {
    console.log('ğŸ” DEBUG - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:');
    console.log('- clientId:', clientId);
    console.log('- typeof clientId:', typeof clientId);
    console.log('- selectedBranchId:', selectedBranchId);
    console.log('- typeof selectedBranchId:', typeof selectedBranchId);
    console.log('- cart items:', cart);
    
    // ğŸ”¥ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† branch_id Ù„Ù‡ Ù‚ÙŠÙ…Ø©
    if (!selectedBranchId || selectedBranchId === 'undefined' || selectedBranchId === 'null') {
        console.error('âŒ Ø®Ø·Ø£: selectedBranchId ØºÙŠØ± ØµØ§Ù„Ø­:', selectedBranchId);
        showMessage('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹! ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹ Ø£ÙˆÙ„Ø§Ù‹', 'error');
        
        // Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹
        showBranchSelection();
        return;
    }
    
    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ù„Ù„ØªØ£ÙƒØ¯
    const branchIdToSend = parseInt(selectedBranchId);
    if (isNaN(branchIdToSend)) {
        console.error('âŒ Ø®Ø·Ø£: branchId Ù„ÙŠØ³ Ø±Ù‚Ù…Ø§Ù‹:', selectedBranchId);
        showMessage('âŒ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ±Ø¹ ØºÙŠØ± ØµØ§Ù„Ø­Ø©', 'error');
        return;
    }
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
    if (!clientId) {
        showMessage('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
        window.location.href = 'login.html';
        return;
    }
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ù„Ø©
    if (cart.length === 0) {
        showMessage('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©', 'error');
        return;
    }
    
    // ğŸ”¥ ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ø³Ù„Ø©
    const items = cart.map(item => {
        console.log(`ğŸ” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù†ØµØ±:`, {
            name: item.name,
            product_id: item.product_id,
            type: typeof item.product_id,
            quantity: item.quantity,
            type2: typeof item.quantity
        });
        
        // ğŸ”¥ Ø§Ø³ØªØ®Ø¯Ù… branch_product_id Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹ (Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        if (item.branch_product_id) {
            return {
                product_type: item.product_type,
                branch_product_id: parseInt(item.branch_product_id), // ğŸ”¥ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                quantity: parseInt(item.quantity)
            };
        } else {
            // Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
            return {
                product_type: item.product_type,
                product_id: parseInt(item.product_id), // ğŸ”¥ ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ø±Ù‚Ù…
                quantity: parseInt(item.quantity)      // ğŸ”¥ ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ø±Ù‚Ù…
            };
        }
    });
    
    // Ø¨Ù†Ø§Ø¡ body Ø§Ù„Ø·Ù„Ø¨
    const requestBody = {
        client_id: parseInt(clientId),
        branch_id: branchIdToSend,
        items: items,
        customer_notes: document.getElementById('prescription')?.value.trim() || null
    };
    
    console.log('ğŸ“¦ requestBody Ø§Ù„Ù…Ø±Ø³Ù„:', JSON.stringify(requestBody, null, 2));
    
    const checkoutBtn = document.getElementById('checkoutBtn');
    const checkoutText = document.getElementById('checkoutText');
    const checkoutLoading = document.getElementById('checkoutLoading');
    
    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    checkoutBtn.disabled = true;
    checkoutText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨...';
    checkoutLoading.style.display = 'inline-block';
    
    try {
        showMessage('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨Ùƒ...', 'info');
        
        const response = await fetch(`${API_BASE}/orders`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        console.log('ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', response.status, response.statusText);
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ 400ØŒ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
        if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', errorData);
            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('âœ… Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù†Ø§Ø¬Ø­Ø©:', data);
        
        if (data.success) {
            showMessage(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${data.data.order_number}`, 'success', 5000);
            
            // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (prescriptionImages.length > 0 && data.data.order_id) {
                await uploadPrescriptionImages(data.data.order_id);
            }
            
            // ØªÙØ±ÙŠØº ÙƒÙ„ Ø´ÙŠØ¡
            cart = [];
            prescriptionImages = [];
            updateCartBadge();
            updateCartDisplay();
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
            resetAllQuantities();
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ù„Ø©
            setTimeout(() => {
                closeCart();
            }, 1000);
            
            // Ø¹Ø±Ø¶ ØªØ£ÙƒÙŠØ¯
            setTimeout(() => {
                const userChoice = confirm(`
                    ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!
                    =======================
                    Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${data.data.order_number}
                    Ø§Ù„ÙØ±Ø¹: ${data.data.branch_name}
                    Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${data.data.total} Ø¬Ù†ÙŠÙ‡
                    Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${data.data.items_count}
                    =======================
                    Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ
                `);
                
                if (userChoice) {
                    window.location.href = 'orderstate.html';
                } else {
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
                    checkoutBtn.disabled = false;
                    checkoutText.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
                    checkoutLoading.style.display = 'none';
                }
            }, 2000);
            
        } else {
            throw new Error(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨');
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨:', error);
        
        let errorMessage = error.message;
        if (error.message.includes('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ø·Ù„Ø¨')) {
            errorMessage = 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage = 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
        } else if (error.message.includes('HTTP 400')) {
            errorMessage = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©';
        } else if (error.message.includes('HTTP 404')) {
            errorMessage = 'Ø§Ù„ÙØ±Ø¹ Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
        } else if (error.message.includes('HTTP 500')) {
            errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±';
        }
        
        showMessage(`âŒ ${errorMessage}`, 'error');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        checkoutBtn.disabled = false;
        checkoutText.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
        checkoutLoading.style.display = 'none';
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
async function uploadPrescriptionImages(orderId) {
    if (prescriptionImages.length === 0) return;
    
    try {
        showMessage(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${prescriptionImages.length} ØµÙˆØ±Ø© Ù„Ù„Ø±ÙˆØ´ØªØ©...`, 'info');
        
        let successfulUploads = 0;
        let failedUploads = 0;
        
        // Ø±ÙØ¹ ÙƒÙ„ ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø­Ø¯Ø©
        for (let i = 0; i < prescriptionImages.length; i++) {
            const imageBase64 = prescriptionImages[i];
            const timestamp = Date.now();
            
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        image_base64: imageBase64,
                        image_name: `prescription_${orderId}_${timestamp}_${i}.jpg`
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    console.log(`âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ${i + 1}:`, data.data);
                    successfulUploads++;
                } else {
                    console.error(`âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ${i + 1}:`, data.message);
                    failedUploads++;
                }
                
            } catch (imageError) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ${i + 1}:`, imageError);
                failedUploads++;
            }
        }
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ø®Øµ
        if (successfulUploads > 0) {
            let message = `ØªÙ… Ø±ÙØ¹ ${successfulUploads} ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­`;
            if (failedUploads > 0) {
                message += `ØŒ ÙˆÙØ´Ù„ Ø±ÙØ¹ ${failedUploads} ØµÙˆØ±Ø©`;
            }
            showMessage(message, successfulUploads === prescriptionImages.length ? 'success' : 'warning');
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±:', error);
        showMessage('ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ±ØŒ Ù„ÙƒÙ† Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'warning');
    }
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ÙƒÙ…ÙŠØ§Øª
function resetAllQuantities() {
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
    drugs.forEach(product => {
        const input = document.getElementById(`qty-drug-${product.id}`);
        if (input) input.value = 0;
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª
    cosmetics.forEach(product => {
        const input = document.getElementById(`qty-cosmetic-${product.id}`);
        if (input) input.value = 0;
    });
}


// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø®Ø·Ø£ Ù…ÙØµÙ„
function showDetailedError(cartItems, branchId) {
    console.warn('âš ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:', {
        cart_items: cartItems,
        branch_id: branchId,
        available_products: {
            drugs: drugs.filter(d => d.branch_id === branchId),
            cosmetics: cosmetics.filter(c => c.branch_id === branchId)
        }
    });
    
    // ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 100%;">
            <h3 style="color: var(--danger); margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle"></i>
                Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            </h3>
            <p style="color: var(--gray-800); margin-bottom: 20px;">
                Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ.
            </p>
            <div style="background: var(--gray-100); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <ul style="color: var(--gray-700);">
                    ${cartItems.map(item => `
                        <li>${item.name} (${item.product_type === 'drug' ? 'Ø¯ÙˆØ§Ø¡' : 'Ù…Ø³ØªØ­Ø¶Ø±'})</li>
                    `).join('')}
                </ul>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="this.parentElement.parentElement.remove(); changeBranch()" 
                        style="flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-store"></i> ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø¹
                </button>
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="flex: 1; background: var(--gray-300); color: var(--gray-700); border: none; padding: 12px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

    async function uploadPrescriptionImages(orderId) {
    if (prescriptionImages.length === 0) return;
    
    try {
        showMessage(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${prescriptionImages.length} ØµÙˆØ±Ø© Ù„Ù„Ø±ÙˆØ´ØªØ©...`, 'info');
        
        let successfulUploads = 0;
        let failedUploads = 0;
        
        // Ø±ÙØ¹ ÙƒÙ„ ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø­Ø¯Ø©
        for (let i = 0; i < prescriptionImages.length; i++) {
            const imageBase64 = prescriptionImages[i];
            const timestamp = Date.now();
            
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        image_base64: imageBase64,
                        image_name: `prescription_${orderId}_${timestamp}_${i}.jpg`
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    console.log(`âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ${i + 1}:`, data.data);
                    successfulUploads++;
                } else {
                    console.error(`âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ${i + 1}:`, data.message);
                    failedUploads++;
                }
                
            } catch (imageError) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ${i + 1}:`, imageError);
                failedUploads++;
            }
        }
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ø®Øµ
        if (successfulUploads > 0) {
            let message = `ØªÙ… Ø±ÙØ¹ ${successfulUploads} ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­`;
            if (failedUploads > 0) {
                message += `ØŒ ÙˆÙØ´Ù„ Ø±ÙØ¹ ${failedUploads} ØµÙˆØ±Ø©`;
            }
            showMessage(message, successfulUploads === prescriptionImages.length ? 'success' : 'warning');
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±:', error);
        showMessage('ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ±ØŒ Ù„ÙƒÙ† Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'warning');
    }
}


    function resetAllQuantities() {
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
        drugs.forEach(product => {
            const input = document.getElementById(`qty-drug-${product.id}`);
            if (input) input.value = 0;
        });
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª
        cosmetics.forEach(product => {
            const input = document.getElementById(`qty-cosmetic-${product.id}`);
            if (input) input.value = 0;
        });
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    // Ø¹Ø¯Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ù„ØªØµØ¨Ø­ Ù‡ÙƒØ°Ø§
document.addEventListener('DOMContentLoaded', () => {
    const storedClient = localStorage.getItem('client');
    const authTime = localStorage.getItem('auth_time');
    
    if (!storedClient || !authTime) {
        window.location.href = 'login.html';
        return;
    }
    
    const timeDiff = Date.now() - parseInt(authTime);
    const hoursDiff = timeDiff / (1000 * 60 * 60);
    
    if (hoursDiff > 24) {
        localStorage.removeItem('client');
        localStorage.removeItem('auth_time');
        localStorage.removeItem('client_id');
        localStorage.removeItem('selected_branch'); // ğŸ”¥ Ø§Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø£ÙŠØ¶Ø§Ù‹
        window.location.href = 'login.html';
        return;
    }
    
    clientData = JSON.parse(storedClient);
    clientId = clientData.id;
    
    document.getElementById('clientInfo').innerHTML = `
        <div class="client-badge">
            <div class="client-name">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${clientData.name}</div>
            <div class="client-address">${clientData.address || 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'}</div>
        </div>
    `;
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹ Ø£ÙˆÙ„Ø§Ù‹
    showBranchSelection();
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ø³Ù„Ø©
    document.getElementById('cartOverlay').addEventListener('click', closeCart);
    
    // ØªØ­Ù…ÙŠÙ„ Ø³Ù„Ø© Ù…Ø­ÙÙˆØ¸Ø©
    const savedCart = localStorage.getItem('saved_cart');
    if (savedCart) {
        try {
            const parsedCart = JSON.parse(savedCart);
            if (Array.isArray(parsedCart)) {
                parsedCart.forEach(item => {
                    const input = document.getElementById(`qty-${item.product_type}-${item.product_id}`);
                    if (input) {
                        input.value = item.quantity;
                        updateCartFromQuantity(item.product_id, item.product_type, item.quantity);
                    }
                });
            }
        } catch (e) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø©:', e);
            localStorage.removeItem('saved_cart');
        }
    }
});

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
function updateCurrentBranchButton() {
    if (selectedBranchId && userBranches.length > 0) {
        const selectedBranch = userBranches.find(b => 
            (b.branch_id || b.branches?.id) == selectedBranchId
        );
        
        if (selectedBranch) {
            const branchName = selectedBranch.branches?.name || `Ø§Ù„ÙØ±Ø¹ ${selectedBranchId}`;
            document.getElementById('currentBranchText').textContent = `Ø§Ù„ÙØ±Ø¹: ${branchName}`;
            document.getElementById('changeBranchBtn').style.display = 'flex';
            
            console.log(`ğŸª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${branchName} (ID: ${selectedBranchId})`);
        }
    }
}

// Ø¹Ø¯Ù„ Ø¯Ø§Ù„Ø© hideBranchModal
function hideBranchModal() {
    const modal = document.getElementById('branchSelectionModal');
    modal.style.display = 'none';
    
    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
    updateCurrentBranchButton();
}

    // Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø©
    window.addEventListener('beforeunload', () => {
        if (cart.length > 0) {
            localStorage.setItem('saved_cart', JSON.stringify(cart));
        } else {
            localStorage.removeItem('saved_cart');
        }
    });
    document.getElementById('confirmBranchBtn').onclick = () => {
    console.log('ğŸ”„ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:');
    console.log('- selectedBranchForShopping:', selectedBranchForShopping);
    
    if (selectedBranchForShopping) {
        // ğŸ”¥ Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ù‡Ù…Ø©: Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        selectedBranchId = parseInt(selectedBranchForShopping);
        
        console.log(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹: ${selectedBranchId}`);
        
        // Ø­ÙØ¸ ÙÙŠ localStorage
        localStorage.setItem('selected_branch', selectedBranchId.toString());
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        updateCurrentBranchButton();
        
        hideBranchModal();
        
        // ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
        loadProducts();
        
        showMessage(`âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹ "${getBranchName(selectedBranchId)}"`, 'success');
    } else {
        console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹!');
        showMessage('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹ Ø£ÙˆÙ„Ø§Ù‹', 'error');
    }
};

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹
function getBranchName(branchId) {
    const branch = userBranches.find(b => 
        (b.branch_id || b.branches?.id) == branchId
    );
    return branch?.branches?.name || `Ø§Ù„ÙØ±Ø¹ ${branchId}`;
}
// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
function updateWelcomeMessage() {
    if (clientData) {
        document.getElementById('welcomeMessage').innerHTML = `
            Ù…Ø±Ø­Ø¨Ø§Ù‹ <strong>${clientData.name}</strong>ØŒ
            ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø°ÙŠ ØªØ±ØºØ¨ Ø¨Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù†Ù‡:
        `;
    }
}
// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ DOM Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
document.addEventListener('DOMContentLoaded', function() {
    // Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ­Ù…ÙŠÙ„ clientData
    setTimeout(() => {
        if (clientData) {
            updateWelcomeMessage();
        }
    }, 100);
});
</script>
</body>
</html>
